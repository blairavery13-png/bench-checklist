<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Installer Daily Report</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b5ed7">

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
  :root{
    --bg:#ffffff;
    --card:#ffffff;
    --border:#dbe2f0;
    --blue:#0b5ed7;
    --text:#000000;
    --muted:#4b5563;
    --good:#16a34a;
    --bad:#dc2626;
  }
  [data-theme="dark"]{
    --bg:#0b1220;
    --card:#0f1b33;
    --border:#233a63;
    --blue:#3b82f6;
    --text:#ffffff;
    --muted:#cbd5e1;
    --good:#22c55e;
    --bad:#ef4444;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family: Arial, Helvetica, sans-serif;
    font-weight:700;
  }
  .wrap{
    max-width: 1000px;
    margin: 0 auto;
    padding: 16px 16px 150px;
  }
  .topRow{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    margin-bottom:10px;
  }
  h1{
    margin:0;
    font-weight:900;
    letter-spacing:.2px;
    font-size:1.4rem;
  }
  .toggle{
    border:1px solid var(--border);
    background:var(--card);
    color:var(--text);
    border-radius:999px;
    padding:10px 14px;
    font-weight:900;
    cursor:pointer;
  }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius: 14px;
    padding: 14px;
    margin-bottom: 14px;
  }
  .row{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
  }
  label{
    display:block;
    font-weight:900;
    margin-bottom:6px;
  }
  input, select, textarea{
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    border: 1px solid var(--border);
    font-weight: 800;
    font-size: 1.05rem;
    background: #fff;
    color:#000;
  }
  [data-theme="dark"] input,
  [data-theme="dark"] select,
  [data-theme="dark"] textarea{
    background:#0b1220;
    color:#fff;
    border-color: var(--border);
  }
  textarea{ min-height: 80px; resize: vertical; }

  .btn{
    appearance:none;
    border:none;
    background: var(--blue);
    color:#fff;
    font-weight:900;
    border-radius:999px;
    padding: 14px 18px;
    cursor:pointer;
    user-select:none;
  }
  .btn.secondary{
    background:#e8f0fe;
    color:var(--blue);
  }
  [data-theme="dark"] .btn.secondary{
    background:#12264a;
    color:#cfe0ff;
  }
  .btn.small{
    padding: 10px 14px;
    font-size: .95rem;
  }
  .btn:disabled{
    opacity:.6;
    cursor:not-allowed;
  }

  .photoGrid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(95px, 1fr));
    gap: 10px;
    margin-top: 10px;
  }
  .thumb{
    border:1px solid var(--border);
    border-radius: 10px;
    overflow:hidden;
    background:#fff;
  }
  [data-theme="dark"] .thumb{ background:#0b1220; }
  .thumb img{
    width: 100%;
    height: 80px;
    object-fit: cover;
    display:block;
  }

  .q{
    border:1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    margin-top: 12px;
  }
  .qTitle{
    font-weight: 900;
    margin-bottom: 8px;
  }
  .choice{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .choice input[type="radio"]{ display:none; }
  .pill{
    border-radius: 999px;
    border: 2px solid var(--border);
    padding: 14px;
    text-align:center;
    cursor:pointer;
    font-weight: 900;
    background: var(--card);
    color: var(--text);
    user-select:none;
  }
  .choice input:checked + .pill.goodSel{
    border-color: var(--good);
    background: color-mix(in srgb, var(--good) 18%, var(--card));
  }
  .choice input:checked + .pill.badSel{
    border-color: var(--bad);
    background: color-mix(in srgb, var(--bad) 18%, var(--card));
  }

  .follow{
    display:none;
    margin-top: 10px;
  }
  .follow .hint{
    font-weight:900;
    color: var(--muted);
    margin: 0 0 8px;
  }

  /* Modal (Camera / Gallery) */
  .modalBackdrop{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.45);
    display:none;
    align-items:center;
    justify-content:center;
    padding: 18px;
    z-index: 9999;
  }
  .modal{
    width: min(520px, 100%);
    background:var(--card);
    color:var(--text);
    border-radius: 16px;
    border:1px solid var(--border);
    padding: 16px;
  }
  .modal h2{
    margin:0 0 10px;
    font-size: 1.15rem;
    font-weight: 900;
  }
  .modal .modalRow{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 12px;
  }
  .modal .modalRow .btn{ width:100%; }
  .modal .closeRow{
    margin-top: 10px;
    display:flex;
    justify-content:flex-end;
  }

  /* Bottom bar */
  .bottom{
    position: fixed;
    left:0; right:0; bottom:0;
    background: var(--card);
    border-top: 1px solid var(--border);
    padding: 10px;
    z-index: 1000;
  }
  .bottomInner{
    max-width: 1000px;
    margin: 0 auto;
    display:flex;
    justify-content: flex-end;
    gap: 10px;
    align-items:center;
  }
  .status{
    font-weight:900;
    color: var(--muted);
    text-align:right;
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="topRow">
    <h1>Installer Daily Report</h1>
    <button class="toggle" type="button" onclick="toggleTheme()">Light / Dark</button>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label>Date</label>
        <input id="date" readonly>
      </div>
      <div>
        <label>Installer</label>
        <select id="installer">
          <option value="">Select</option>
          <option>Installer 1</option>
          <option>Installer 2</option>
          <option>Installer 3</option>
          <option>Installer 4</option>
        </select>
      </div>
      <div>
        <label>Job Number</label>
        <input id="job" value="JB">
      </div>
    </div>
    <div style="margin-top:10px">
      <label>Installed Rooms</label>
      <input id="rooms" placeholder="Kitchen, Laundry, Vanities">
    </div>
  </div>

  <div class="card">
    <label>Pre Photos</label>
    <button class="btn secondary" type="button" onclick="openPhotoChoice('pre')">Add Pre Photos</button>
    <div id="preGrid" class="photoGrid"></div>
  </div>

  <div class="card">
    <label>Issue Photos</label>
    <button class="btn secondary" type="button" onclick="openPhotoChoice('issue')">Add Issue Photos</button>
    <div id="issueGrid" class="photoGrid"></div>
  </div>

  <div class="card">
    <label>Final Photos</label>
    <button class="btn secondary" type="button" onclick="openPhotoChoice('final')">Add Final Photos</button>
    <div id="finalGrid" class="photoGrid"></div>
  </div>

  <div class="card">
    <div style="font-weight:900;">Checklist</div>
    <div id="checklist"></div>
  </div>
</div>

<div class="bottom">
  <div class="bottomInner">
    <div id="exportStatus" class="status"></div>
    <button id="exportBtn" class="btn" type="button" onclick="exportZIP()">Finish & Export</button>
  </div>
</div>

<!-- Hidden inputs -->
<input id="camInput" type="file" accept="image/*" capture="environment" multiple hidden>
<input id="galInput" type="file" accept="image/*" multiple hidden>

<!-- Modal -->
<div id="modalBackdrop" class="modalBackdrop" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <h2 id="modalTitle">Add Photos</h2>
    <div class="modalRow">
      <button class="btn" type="button" onclick="chooseCamera()">Camera</button>
      <button class="btn secondary" type="button" onclick="chooseGallery()">Gallery</button>
    </div>
    <div class="closeRow">
      <button class="btn secondary small" type="button" onclick="forceCloseModal()">Close</button>
    </div>
  </div>
</div>

<script>
/* ---------------- Theme toggle ---------------- */
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  try{ localStorage.setItem("installerTheme", theme); }catch(_){}
}
function toggleTheme(){
  const current = document.documentElement.getAttribute("data-theme") || "light";
  applyTheme(current === "dark" ? "light" : "dark");
}
(function initTheme(){
  let saved = "light";
  try{ saved = localStorage.getItem("installerTheme") || "light"; }catch(_){}
  applyTheme(saved);
})();

/* ---------------- Questions (commentOn is the answer that must show comments) ---------------- */
const QUESTION_DEFS = [
  { text: "Prior damage to walls / area?",            badAnswer: "Yes", commentOn: "Yes" },
  { text: "Prior damage to cabinetry?",               badAnswer: "Yes", commentOn: "Yes" },
  { text: "Access issues?",                           badAnswer: "Yes", commentOn: "Yes" },
  { text: "Site issues?",                             badAnswer: "Yes", commentOn: "Yes" },
  { text: "Was installation delayed?",                badAnswer: "Yes", commentOn: "Yes" },

  { text: "Wall dimensions correct?",                 badAnswer: "No",  commentOn: "No"  },
  { text: "Bulkheads / kickboards correct?",          badAnswer: "No",  commentOn: "No"  },
  { text: "Doors / drawers operating correctly?",     badAnswer: "No",  commentOn: "No"  },

  { text: "Cabinet build correct?",                   badAnswer: "No",  commentOn: "No",  special: "build" },

  { text: "Cabinetry missing?",                       badAnswer: "Yes", commentOn: "Yes" },

  { text: "Hardware missing?",                        badAnswer: "Yes", commentOn: "Yes" },
  { text: "Hardware incorrect?",                      badAnswer: "Yes", commentOn: "Yes" },
  { text: "Handles fitted / correct?",                badAnswer: "No",  commentOn: "No"  },
  { text: "Bump-ons fitted?",                         badAnswer: "No",  commentOn: "No"  },

  { text: "Plastic legs incorrect?",                  badAnswer: "Yes", commentOn: "Yes" },

  { text: "Pull-out / lighting issues?",              badAnswer: "Yes", commentOn: "Yes" },
  { text: "Return visit required?",                   badAnswer: "Yes", commentOn: "Yes" },
  { text: "Dispute / builder claim risk?",            badAnswer: "Yes", commentOn: "Yes" }
];

/* ---------------- Elements ---------------- */
const jobEl = document.getElementById("job");
const roomsEl = document.getElementById("rooms");
const installerEl = document.getElementById("installer");
const dateEl = document.getElementById("date");
const checklistEl = document.getElementById("checklist");
const exportBtn = document.getElementById("exportBtn");
const exportStatus = document.getElementById("exportStatus");

dateEl.value = new Date().toLocaleDateString();

/* Keep JB prefix */
jobEl.addEventListener("input", () => {
  let v = (jobEl.value || "").toUpperCase();
  if (!v.startsWith("JB")) v = "JB" + v.replace(/[^0-9]/g, "");
  const digits = v.slice(2).replace(/[^0-9]/g, "");
  jobEl.value = ("JB" + digits).toUpperCase();
});

/* ---------------- Photos state ---------------- */
const photos = { pre: [], issue: [], final: [] };   // originals
const thumbs = { pre: [], issue: [], final: [] };   // small dataURLs
let activePhotoBucket = "pre";

/* ---------------- Checklist build ---------------- */
function buildChecklist(){
  checklistEl.innerHTML = "";

  QUESTION_DEFS.forEach((q, idx) => {
    const qWrap = document.createElement("div");
    qWrap.className = "q";
    qWrap.dataset.index = String(idx);

    const title = document.createElement("div");
    title.className = "qTitle";
    title.textContent = `${idx + 1}. ${q.text}`;
    qWrap.appendChild(title);

    const choice = document.createElement("div");
    choice.className = "choice";

    const yesIsBad = q.badAnswer === "Yes";
    const noIsBad  = q.badAnswer === "No";

    const yesId = `q${idx}_yes`;
    const noId  = `q${idx}_no`;

    const yesRadio = document.createElement("input");
    yesRadio.type = "radio";
    yesRadio.name = `q${idx}`;
    yesRadio.value = "Yes";
    yesRadio.id = yesId;

    const yesLabel = document.createElement("label");
    yesLabel.className = "pill " + (yesIsBad ? "badSel" : "goodSel");
    yesLabel.setAttribute("for", yesId);
    yesLabel.textContent = "Yes";

    const noRadio = document.createElement("input");
    noRadio.type = "radio";
    noRadio.name = `q${idx}`;
    noRadio.value = "No";
    noRadio.id = noId;

    const noLabel = document.createElement("label");
    noLabel.className = "pill " + (noIsBad ? "badSel" : "goodSel");
    noLabel.setAttribute("for", noId);
    noLabel.textContent = "No";

    choice.appendChild(yesRadio);
    choice.appendChild(yesLabel);
    choice.appendChild(noRadio);
    choice.appendChild(noLabel);
    qWrap.appendChild(choice);

    const follow = document.createElement("div");
    follow.className = "follow";

    if(q.special === "build"){
      follow.innerHTML = `
        <div class="hint">Required when answer is <b>${q.commentOn}</b></div>
        <input class="builtBy" placeholder="Built by (name / bench / colour)">
        <textarea class="issueText" placeholder="Issue"></textarea>
      `;
    } else {
      follow.innerHTML = `
        <div class="hint">Required when answer is <b>${q.commentOn}</b></div>
        <textarea class="commentText" placeholder="Comment"></textarea>
      `;
    }
    qWrap.appendChild(follow);

    function syncFollow(){
      const selected = qWrap.querySelector(`input[name="q${idx}"]:checked`);
      const val = selected ? selected.value : null;
      follow.style.display = (val === q.commentOn) ? "block" : "none";
    }
    yesRadio.addEventListener("change", syncFollow);
    noRadio.addEventListener("change", syncFollow);

    checklistEl.appendChild(qWrap);
  });
}
buildChecklist();

/* ---------------- Photo modal (Camera OR Gallery) ---------------- */
const modalBackdrop = document.getElementById("modalBackdrop");
const modalTitle = document.getElementById("modalTitle");
const camInput = document.getElementById("camInput");
const galInput = document.getElementById("galInput");

function openPhotoChoice(bucket){
  activePhotoBucket = bucket;
  modalTitle.textContent =
    bucket === "pre" ? "Add Pre Photos" :
    bucket === "issue" ? "Add Issue Photos" : "Add Final Photos";
  modalBackdrop.style.display = "flex";
}
function closeModal(){ modalBackdrop.style.display = "none"; }
function forceCloseModal(){ modalBackdrop.style.display = "none"; }
function chooseCamera(){ closeModal(); camInput.click(); }
function chooseGallery(){ closeModal(); galInput.click(); }

camInput.addEventListener("change", async (e) => {
  await handleFiles(e.target.files);
  camInput.value = "";
});
galInput.addEventListener("change", async (e) => {
  await handleFiles(e.target.files);
  galInput.value = "";
});

/* ---------------- Thumbnails (small in app) ---------------- */
async function makeThumb(file){
  const img = await createImageBitmap(file);
  const targetW = 140;
  const scale = targetW / img.width;
  const canvas = document.createElement("canvas");
  canvas.width = targetW;
  canvas.height = Math.max(1, Math.round(img.height * scale));
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  if (img && typeof img.close === "function") img.close();
  return canvas.toDataURL("image/jpeg", 0.65);
}

async function handleFiles(fileList){
  if(!fileList || !fileList.length) return;
  for(const f of Array.from(fileList)){
    photos[activePhotoBucket].push(f);
    thumbs[activePhotoBucket].push(await makeThumb(f));
  }
  renderPhotoGrids();
}

function renderPhotoGrids(){
  ["pre","issue","final"].forEach(renderGrid);
}
function renderGrid(bucket){
  const grid = document.getElementById(bucket + "Grid");
  grid.innerHTML = "";
  thumbs[bucket].forEach((src) => {
    const d = document.createElement("div");
    d.className = "thumb";
    d.innerHTML = `<img src="${src}" alt="">`;
    grid.appendChild(d);
  });
}

/* ---------------- PDF helpers ---------------- */
function pdfWriteWrapped(doc, text, x, y, maxW, lineH){
  const lines = doc.splitTextToSize(text, maxW);
  doc.text(lines, x, y);
  return y + (lines.length * lineH);
}

/* ---------------- JSON helper ---------------- */
function buildJSON(job, installer, rooms, date){
  const answers = QUESTION_DEFS.map((q, idx) => {
    const qNode = document.querySelector(`.q[data-index="${idx}"]`);
    const selected = qNode.querySelector(`input[name="q${idx}"]:checked`);
    const val = selected ? selected.value : null;

    const out = { number: idx + 1, question: q.text, answer: val, commentRequiredOn: q.commentOn };

    if(val === q.commentOn){
      if(q.special === "build"){
        out.builtBy = qNode.querySelector(".builtBy")?.value || "";
        out.issue = qNode.querySelector(".issueText")?.value || "";
      } else {
        out.comment = qNode.querySelector(".commentText")?.value || "";
      }
    }
    return out;
  });

  return { job, installer, rooms, date, createdAtISO: new Date().toISOString(), answers };
}

/* ---------------- EXPORT (Option 1: Save picker / Download only) ---------------- */
function safeFilename(name){
  return String(name || "")
    .replace(/[\/\\:*?"<>|]/g, "-")
    .replace(/\s+/g, " ")
    .trim();
}

async function saveViaPicker(blob, filename){
  // File System Access API (now available on Android Chrome in newer versions)
  if (!window.showSaveFilePicker) return false;

  const opts = {
    suggestedName: filename,
    types: [{
      description: "ZIP archive",
      accept: { "application/zip": [".zip"] }
    }]
  };

  const handle = await window.showSaveFilePicker(opts);
  const writable = await handle.createWritable();
  await writable.write(blob);
  await writable.close();
  return true;
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 1200);
}

async function exportZIP(){
  exportBtn.disabled = true;
  exportStatus.textContent = "Exporting… (may take a moment)";

  try{
    const job = (jobEl.value || "JB").toUpperCase();
    const installer = installerEl.value || "Installer";
    const rooms = roomsEl.value || "";
    const date = dateEl.value || "";

    const zipBase = safeFilename(`${job} – ${installer} – ${date}`);
    const zipFileName = `${zipBase}.zip`;

    const zip = new JSZip();

    // PDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"mm", format:"a4" });

    let y = 12;
    doc.setFont("helvetica","normal");
    doc.setFontSize(14);
    doc.text("Installer Daily Report", 10, y); y += 9;

    doc.setFontSize(11);
    doc.text(`Job: ${job}`, 10, y); y += 6;
    doc.text(`Rooms: ${rooms}`, 10, y); y += 6;
    doc.text(`Installer: ${installer}`, 10, y); y += 6;
    doc.text(`Date: ${date}`, 10, y); y += 8;

    doc.setFontSize(10);

    QUESTION_DEFS.forEach((q, idx) => {
      const qNode = document.querySelector(`.q[data-index="${idx}"]`);
      const selected = qNode.querySelector(`input[name="q${idx}"]:checked`);
      const val = selected ? selected.value : "Not answered";

      if(y > 270){ doc.addPage(); y = 12; }

      y = pdfWriteWrapped(doc, `${idx + 1}. ${q.text}`, 10, y, 190, 5);
      y = pdfWriteWrapped(doc, `Answer: ${val}`, 14, y, 186, 5);

      if(val === q.commentOn){
        if(q.special === "build"){
          const builtBy = qNode.querySelector(".builtBy")?.value?.trim() || "";
          const issue = qNode.querySelector(".issueText")?.value?.trim() || "";
          if(builtBy) y = pdfWriteWrapped(doc, `Built by: ${builtBy}`, 14, y, 186, 5);
          if(issue)   y = pdfWriteWrapped(doc, `Issue: ${issue}`, 14, y, 186, 5);
          if(!builtBy && !issue) y = pdfWriteWrapped(doc, `Comment required (not entered)`, 14, y, 186, 5);
        } else {
          const comment = qNode.querySelector(".commentText")?.value?.trim() || "";
          if(comment) y = pdfWriteWrapped(doc, `Comment: ${comment}`, 14, y, 186, 5);
          else y = pdfWriteWrapped(doc, `Comment required (not entered)`, 14, y, 186, 5);
        }
      }
      y += 2;
    });

    zip.file("Daily Report.pdf", doc.output("arraybuffer"));

    // Photos (originals in ZIP). IMPORTANT: no {binary:true}
    const folderMap = [
      ["pre", "Photos – Pre Install"],
      ["issue", "Photos – Issues"],
      ["final", "Photos – Final"]
    ];
    folderMap.forEach(([bucket, folderName]) => {
      const f = zip.folder(folderName);
      photos[bucket].forEach((file, i) => {
        const ext = (file.name && file.name.includes(".")) ? file.name.split(".").pop() : "jpg";
        const safeExt = (ext || "jpg").toLowerCase().replace(/[^a-z0-9]/g, "") || "jpg";
        const num = String(i + 1).padStart(2, "0");
        f.file(`${bucket}_${num}.${safeExt}`, file);
      });
    });

    zip.file("Report Data.json", JSON.stringify(buildJSON(job, installer, rooms, date), null, 2));

    const blob = await zip.generateAsync({
      type: "blob",
      streamFiles: true,
      compression: "STORE"
    });

    // 1) Best: Save picker (lets them pick Drive if it appears)
    let saved = false;
    try{
      exportStatus.textContent = "Choose where to save…";
      saved = await saveViaPicker(blob, zipFileName);
    } catch(e){
      // If user cancels picker, fall back to download
      saved = false;
    }

    // 2) Fallback: normal Chrome download
    if(!saved){
      exportStatus.textContent = "Starting download…";
      downloadBlob(blob, zipFileName);

      // You can’t reliably force Chrome to open downloads from JS.
      // So we show a clear instruction instead of fake “auto-open”.
      exportStatus.textContent = "Download started. Tap the download bar → Save to Drive.";
      alert("Download started.\nTap the Chrome download bar, then choose 'Save to Drive'.");
    } else {
      exportStatus.textContent = "Saved.";
    }

  } catch (err){
    console.error(err);
    exportStatus.textContent = "";
    alert("Export failed. Try again.");
  } finally {
    exportBtn.disabled = false;
    setTimeout(()=>{ exportStatus.textContent = ""; }, 3500);
  }
}
</script>
</body>
</html>
