<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Installer Daily Report</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b5ed7">

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
/* ——— unchanged styles ——— */
body{margin:0;font-family:Arial,Helvetica,sans-serif;font-weight:700;background:#fff;color:#000}
.wrap{max-width:1000px;margin:auto;padding:16px 16px 140px}
h1{margin:0 0 10px;font-weight:900}
.card{border:1px solid #dbe2f0;border-radius:14px;padding:14px;margin-bottom:14px}
.row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
label{font-weight:900;margin-bottom:6px;display:block}
input,select,textarea{width:100%;padding:14px;border-radius:12px;border:1px solid #dbe2f0;font-weight:800;font-size:1.05rem}
textarea{min-height:80px}
.btn{background:#0b5ed7;color:#fff;border:none;border-radius:999px;padding:14px 20px;font-weight:900}
.btn.secondary{background:#e8f0fe;color:#0b5ed7}
.photoGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-top:10px}
.thumb{border:1px solid #dbe2f0;border-radius:10px;overflow:hidden}
.thumb img{width:100%;height:80px;object-fit:cover}
.q{border:1px solid #dbe2f0;border-radius:12px;padding:12px;margin-top:12px}
.choice{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
.choice input{display:none}
.choice label{padding:14px;border-radius:999px;border:2px solid #dbe2f0;text-align:center}
.choice input:checked+label.goodSel{background:#dcfce7;border-color:#16a34a}
.choice input:checked+label.badSel{background:#fee2e2;border-color:#dc2626}
.follow{display:none;margin-top:10px}
.bottom{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #dbe2f0;padding:10px}
.bottomInner{max-width:1000px;margin:auto;display:flex;justify-content:flex-end}
</style>
</head>

<body>
<div class="wrap">
<h1>Installer Daily Report</h1>

<div class="card">
<div class="row">
<div><label>Date</label><input id="date" readonly></div>
<div>
<label>Installer</label>
<select id="installer">
<option value="">Select</option>
<option>Installer 1</option>
<option>Installer 2</option>
<option>Installer 3</option>
<option>Installer 4</option>
</select>
</div>
<div><label>Job Number</label><input id="job" value="JB"></div>
</div>
<div style="margin-top:10px">
<label>Installed Rooms</label>
<input id="rooms">
</div>
</div>

<div class="card">
<label class="btn secondary">Add Pre Photos<input type="file" id="pre" accept="image/*" multiple hidden></label>
<div id="preGrid" class="photoGrid"></div>
</div>

<div class="card">
<label class="btn secondary">Add Issue Photos<input type="file" id="issue" accept="image/*" multiple hidden></label>
<div id="issueGrid" class="photoGrid"></div>
</div>

<div class="card">
<label class="btn secondary">Add Final Photos<input type="file" id="final" accept="image/*" multiple hidden></label>
<div id="finalGrid" class="photoGrid"></div>
</div>

<div class="card">
<b>Checklist</b>
<div id="checklist"></div>
</div>
</div>

<div class="bottom">
<div class="bottomInner">
<button class="btn" onclick="exportZIP()">Finish & Export ZIP</button>
</div>
</div>

<script>
/* ---------- SAFE EXPORT FIX ---------- */

const jobEl = document.getElementById("job");
const roomsEl = document.getElementById("rooms");
const installerEl = document.getElementById("installer");
const dateEl = document.getElementById("date");
dateEl.value = new Date().toLocaleDateString();

const photos={pre:[],issue:[],final:[]};
["pre","issue","final"].forEach(k=>{
document.getElementById(k).onchange=e=>{
photos[k].push(...e.target.files);
};
});

async function exportZIP(){
try{
const job = (jobEl.value || "JB").toUpperCase();
const rooms = roomsEl.value || "";
const installer = installerEl.value || "";
const date = dateEl.value || "";

const zip = new JSZip();

/* SAFE jsPDF usage */
const { jsPDF } = window.jspdf;
const doc = new jsPDF({unit:"mm",format:"a4"});

let y=12;
doc.setFontSize(12);
doc.text(`Job: ${job}`,10,y);y+=7;
doc.text(`Rooms: ${rooms}`,10,y);y+=7;
doc.text(`Installer: ${installer}`,10,y);y+=7;
doc.text(`Date: ${date}`,10,y);y+=10;

/* Checklist summary (simple & stable) */
document.querySelectorAll(".q").forEach((q,i)=>{
if(y>270){doc.addPage();y=12;}
doc.text(`${i+1}. ${q.innerText.replace(/\s+/g," ")}`,10,y);
y+=8;
});

zip.file("Daily Report.pdf",doc.output("arraybuffer"));

["pre","issue","final"].forEach(k=>{
const f=zip.folder(`Photos – ${k}`);
photos[k].forEach((p,i)=>f.file(`${k}_${i+1}.jpg`,p));
});

const blob=await zip.generateAsync({type:"blob"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download=`${job}_${date}.zip`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);

}catch(err){
console.error(err);
alert("Export failed. Try again.");
}
}
</script>
</body>
</html>
