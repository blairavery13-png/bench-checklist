<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Bench Checklist</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#0b1120;color:#e5e7eb;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;font-size:18px}
    body{display:flex;justify-content:center;padding:16px}

    .app{width:100%;max-width:980px;background:#111827;border-radius:16px;padding:20px;border:1px solid #1f2937}

    .topBar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;flex-wrap:wrap}

    .dot{width:14px;height:14px;border-radius:999px;background:#ef4444;box-shadow:0 0 0 4px rgba(239,68,68,.12)}
    .dot.green{background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.12)}

    .btn{padding:10px 16px;border-radius:999px;border:1px solid #4b5563;background:#020617;color:#e5e7eb;font-size:.9rem;cursor:pointer;font-weight:950;letter-spacing:.2px}
    .btn.primary{border-color:#2563eb;background:#1d4ed8}
    .btn:disabled{opacity:.45;cursor:not-allowed}

    .section-title{margin:18px 0 10px;font-size:1.15rem;font-weight:900;border-bottom:1px solid #1f2937;padding-bottom:6px}

    .field-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:12px}
    .field label{font-size:.9rem;font-weight:900}
    .field input{width:100%;padding:12px;font-size:1rem;margin-top:4px;border-radius:10px;background:#020617;border:1px solid #4b5563;color:#e5e7eb;font-weight:800}

    .required-missing{border-color:#ef4444 !important;box-shadow:0 0 0 4px rgba(239,68,68,.12)}

    .question{background:#020617;border:1px solid #1f2937;border-radius:14px;padding:14px;margin-bottom:16px}
    .q-text{margin-bottom:12px;font-size:1.05rem;font-weight:950;letter-spacing:.1px}

    .answers{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .answers.two{grid-template-columns:repeat(2,1fr)}
    .answers input[type=radio]{display:none}

    .answers label{
      padding:14px 0;text-align:center;border-radius:999px;border:1px solid #4b5563;background:#111827;
      cursor:pointer;user-select:none;font-weight:950;letter-spacing:.2px
    }
    .answers input[type=radio]:checked + label.yes{background:#16a34a;border-color:#16a34a}
    .answers input[type=radio]:checked + label.no{background:#b91c1c;border-color:#b91c1c}
    .answers input[type=radio]:checked + label.na{background:#374151;border-color:#9ca3af}

    /* Disabled look for YES/NO labels when inputs disabled */
    .answers input[type=radio]:disabled + label{
      opacity:.45;
      cursor:not-allowed;
    }

    .notes{margin-top:12px}
    .notes textarea{width:100%;min-height:70px;padding:10px;border-radius:10px;background:#020617;border:1px solid #4b5563;color:#e5e7eb;font-size:.95rem;resize:vertical;font-weight:800}

    .bottomBar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
  </style>
</head>

<body>
  <div class="app">
    <div class="topBar">
      <button type="button" class="btn" onclick="loadJSON()">Load JSON</button>
      <span id="dot" class="dot" aria-label="Status"></span>
    </div>

    <div class="section-title">Job Details</div>
    <div class="field-row">
      <div class="field">
        <label for="filledBy">Checklist filled by</label>
        <input id="filledBy" placeholder="Name">
      </div>
      <div class="field">
        <label for="jobNumber">Job number</label>
        <input id="jobNumber" placeholder="JB8093">
      </div>
      <div class="field">
        <label for="room">Room</label>
        <input id="room" placeholder="Kitchen / Laundry / Vanity">
      </div>
    </div>

    <div class="section-title">Checklist</div>
    <div id="questions"></div>

    <div class="section-title">Final Confirmation</div>
    <div id="finalConfirmCard" class="question">
      <div class="q-text">Is this room complete and has all cabinetry &amp; required hardware been supplied?</div>
      <div class="answers two">
        <input type="radio" name="finalConfirm" id="finalYes" value="Yes">
        <label for="finalYes" class="yes">üü¢ YES</label>

        <input type="radio" name="finalConfirm" id="finalNo" value="No">
        <label for="finalNo" class="no">üî¥ NO</label>
      </div>
    </div>

    <div class="bottomBar">
      <button type="button" class="btn" onclick="saveJSON()">Save Draft (JSON)</button>
      <button id="exportBtn" type="button" class="btn primary" onclick="exportCompletionPDF()">Export Completion Sheet (PDF)</button>
    </div>

    <input type="file" id="fileInput" accept=".json,application/json" style="display:none">
  </div>

<script>
  // ===== Checklist Questions (edit anytime; auto-numbered) =====
  const QUESTIONS = [
    "Colour caps supplied?",
    "Sizes checked (kicks / panels / bulkheads)?",
    "LEDs supplied & tested?",
    "Handles / sharknose rails installed?",
    "Cleats supplied (bulkheads / overheads)?",
    "Doors & drawers defect free?",
    "Aluminium angle cut and supplied?",
    "Cutlery tray installed (if required)?",
    "Bins installed (if required)?",
    "Finished ends correct and fitted?",
    "Appliance panels supplied?",
    "Shadowline / scribes installed?",
    "Soft-close mechanisms working?",
    "Special / custom hardware installed?"
  ];

  const DRAFT_EMOJI = "üî¥";
  const DONE_EMOJI  = "üü¢";
  const TODAY = new Date().toLocaleDateString();

  const filledByInput  = document.getElementById("filledBy");
  const jobNumberInput = document.getElementById("jobNumber");
  const roomInput      = document.getElementById("room");
  const fileInput      = document.getElementById("fileInput");

  const questionsWrap  = document.getElementById("questions");
  const exportBtn      = document.getElementById("exportBtn");
  const dot            = document.getElementById("dot");

  const finalConfirmCard = document.getElementById("finalConfirmCard");
  const finalYesInput = document.getElementById("finalYes");
  const finalNoInput  = document.getElementById("finalNo");

  function escapeHtml(str){
    return String(str||"")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function safeName(str){
    return String(str||"")
      .replace(/[\/\\:*?"<>|]/g,"")
      .replace(/\s+/g,"_")
      .replace(/[^a-z0-9_-]/gi,"")
      .trim();
  }

  function getHeader(){
    return {
      filledBy: (filledByInput.value||"").trim(),
      jobNumber:(jobNumberInput.value||"").trim(),
      room:     (roomInput.value||"").trim()
    };
  }

  function getFinalConfirm(){
    const sel = document.querySelector('input[name="finalConfirm"]:checked');
    return sel ? sel.value : null;
  }

  function renderQuestions(){
    questionsWrap.innerHTML = "";
    QUESTIONS.forEach((text, idx) => {
      const qDiv = document.createElement("div");
      qDiv.className = "question";
      qDiv.dataset.qtext = text;

      const n = idx + 1;
      const name = "q" + idx;

      qDiv.innerHTML = `
        <div class="q-text">${n}. ${escapeHtml(text)}</div>
        <div class="answers">
          <input type="radio" name="${name}" id="${name}y" value="Yes"><label for="${name}y" class="yes">Yes</label>
          <input type="radio" name="${name}" id="${name}n" value="No"><label for="${name}n" class="no">No</label>
          <input type="radio" name="${name}" id="${name}a" value="N/A"><label for="${name}a" class="na">N/A</label>
        </div>
        <div class="notes" style="display:none">
          <textarea placeholder="Notes"></textarea>
        </div>
      `;

      // Notes only show on NO; auto-clear on YES/N/A
      qDiv.addEventListener("change", (e) => {
        if(!e.target || e.target.type !== "radio") return;

        const val = String(e.target.value || "").toLowerCase();
        const notesWrap = qDiv.querySelector(".notes");
        const notesEl = qDiv.querySelector("textarea");

        if(val === "no"){
          notesWrap.style.display = "";
          // require a reason for NO (visual)
          if(!notesEl.value.trim()) notesEl.classList.add("required-missing");
          setTimeout(()=>notesEl.focus(),0);
        }else{
          notesEl.value = "";
          notesEl.classList.remove("required-missing");
          notesWrap.style.display = "none";
        }

        evaluateCompletionState();
      });

      // live note validation when NO selected
      const notesEl = qDiv.querySelector("textarea");
      notesEl.addEventListener("input", () => {
        const selected = qDiv.querySelector('input[type="radio"]:checked');
        const ans = selected ? String(selected.value).toLowerCase() : "";
        if(ans === "no"){
          notesEl.classList.toggle("required-missing", !notesEl.value.trim());
        }else{
          notesEl.classList.remove("required-missing");
        }
        evaluateCompletionState();
      });

      questionsWrap.appendChild(qDiv);
    });
  }

  function getQuestionsData(){
    const out = [];
    const qDivs = document.querySelectorAll("#questions .question");

    qDivs.forEach((qDiv, idx) => {
      const selected = qDiv.querySelector('input[type="radio"]:checked');
      const ans = selected ? selected.value : null;

      const notesWrap = qDiv.querySelector(".notes");
      const notesEl = qDiv.querySelector("textarea");
      let notes = "";

      // Notes only valid on NO (otherwise cleared)
      if(ans && String(ans).toLowerCase() === "no"){
        notes = notesEl.value || "";
        notesWrap.style.display = "";
        notesEl.classList.toggle("required-missing", !notes.trim());
      }else{
        notesEl.value = "";
        notesEl.classList.remove("required-missing");
        notesWrap.style.display = "none";
      }

      out.push({
        number: idx + 1,
        question: qDiv.dataset.qtext || `Q${idx+1}`,
        answer: ans,
        notes: notes
      });
    });

    return out;
  }

  function markRequiredUI(){
    const {filledBy, jobNumber, room} = getHeader();

    filledByInput.classList.toggle("required-missing", !filledBy);
    jobNumberInput.classList.toggle("required-missing", !jobNumber);
    roomInput.classList.toggle("required-missing", !room);

    // Unanswered questions highlighted
    document.querySelectorAll("#questions .question").forEach(qDiv => {
      const selected = qDiv.querySelector('input[type="radio"]:checked');
      qDiv.classList.toggle("required-missing", !selected);
    });
  }

  function computeChecklistState(){
    const header = getHeader();
    const missingHeader = (!header.filledBy || !header.jobNumber || !header.room);

    const answers = getQuestionsData();
    const anyUnanswered = answers.some(a => !a.answer);
    const anyNo = answers.some(a => String(a.answer||"").toLowerCase() === "no");
    const anyNotes = answers.some(a => (a.notes||"").trim().length > 0);

    // If NO exists, notes must exist for each NO (enforced for saving drafts)
    const anyNoMissingNotes = answers.some(a =>
      String(a.answer||"").toLowerCase() === "no" && !(a.notes||"").trim()
    );

    return { missingHeader, anyUnanswered, anyNo, anyNotes, anyNoMissingNotes };
  }

  function setFinalYesEnabled(enabled){
    finalYesInput.disabled = !enabled;

    // If final YES is selected but becomes invalid, force back to NO
    const fc = getFinalConfirm();
    if(!enabled && fc === "Yes"){
      finalYesInput.checked = false;
      finalNoInput.checked = true;
    }
  }

  function evaluateCompletionState(){
    markRequiredUI();

    const { missingHeader, anyUnanswered, anyNo, anyNotes } = computeChecklistState();

    // "Eligible to mark YES complete" means: header ok + all answered + no NO + no notes.
    const canSelectFinalYes = !missingHeader && !anyUnanswered && !anyNo && !anyNotes;
    setFinalYesEnabled(canSelectFinalYes);

    // Export ONLY when perfectly clean + final YES
    const final = getFinalConfirm();
    const canExport = canSelectFinalYes && (final === "Yes");

    exportBtn.disabled = !canExport;
    dot.classList.toggle("green", canExport);
  }

  document.addEventListener("change", evaluateCompletionState);
  document.addEventListener("input", evaluateCompletionState);

  function saveJSON(){
    // Drafts do NOT require final confirmation.
    const header = getHeader();
    const missing = [];
    if(!header.filledBy) missing.push("Checklist filled by");
    if(!header.jobNumber) missing.push("Job number");
    if(!header.room) missing.push("Room");

    // If there are NO answers, notes are mandatory for each NO.
    const { anyNoMissingNotes } = computeChecklistState();

    if(missing.length){
      evaluateCompletionState();
      alert("Save Draft blocked.\n\nPlease fill:\n- " + missing.join("\n- "));
      return;
    }
    if(anyNoMissingNotes){
      evaluateCompletionState();
      alert("Save Draft blocked.\n\nAny NO must have a note explaining why.");
      return;
    }

    const data = {
      app: "Bench Checklist",
      version: 5,
      date: TODAY,
      ...header,
      finalConfirm: getFinalConfirm(),   // stored if chosen, but not required
      questions: QUESTIONS.slice(),
      answers: getQuestionsData()
    };

    const fileName =
      `${DRAFT_EMOJI}_` +
      safeName(header.jobNumber) + "_" +
      safeName(header.room) + "_" +
      safeName(header.filledBy) + "_DRAFT.json";

    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  function loadJSON(){
    fileInput.value = "";
    fileInput.click();
  }

  fileInput.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      try{
        const data = JSON.parse(evt.target.result || "{}");

        filledByInput.value  = data.filledBy  || "";
        jobNumberInput.value = data.jobNumber || "";
        roomInput.value      = data.room      || "";

        // Load questions by index (simple by design)
        const qDivs = document.querySelectorAll("#questions .question");
        qDivs.forEach((qDiv, idx) => {
          const entry = (data.answers && data.answers[idx]) ? data.answers[idx] : null;

          qDiv.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);

          const ans = entry && entry.answer ? entry.answer : null;
          if(ans){
            const match = qDiv.querySelector('input[type="radio"][value="' + ans + '"]');
            if(match) match.checked = true;
          }

          const notesWrap = qDiv.querySelector(".notes");
          const notesEl = qDiv.querySelector("textarea");

          if(ans && String(ans).toLowerCase() === "no"){
            notesWrap.style.display = "";
            notesEl.value = (entry && entry.notes) ? entry.notes : "";
            notesEl.classList.toggle("required-missing", !notesEl.value.trim());
          }else{
            notesEl.value = "";
            notesEl.classList.remove("required-missing");
            notesWrap.style.display = "none";
          }
        });

        // Final confirm (load if present)
        document.querySelectorAll('input[name="finalConfirm"]').forEach(r => r.checked = false);
        if(data.finalConfirm){
          const fc = document.querySelector('input[name="finalConfirm"][value="' + data.finalConfirm + '"]');
          if(fc) fc.checked = true;
        }

        evaluateCompletionState();
      }catch(_){
        alert("Invalid JSON file.");
      }
    };
    reader.readAsText(file);
  });

  function exportCompletionPDF(){
    evaluateCompletionState();
    if(exportBtn.disabled){
      alert("Not ready ‚Äî check red highlights.");
      return;
    }

    const header = getHeader();
    const answers = getQuestionsData();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"mm", format:"a4" });

    let y = 14;
    doc.setFont("helvetica","bold");
    doc.setFontSize(16);
    doc.text("Cabinetry Completion Sheet", 10, y); y += 10;

    doc.setFontSize(11);
    doc.setFont("helvetica","normal");
    doc.text(`Job Number: ${header.jobNumber}`, 10, y); y += 6;
    doc.text(`Room: ${header.room}`, 10, y); y += 6;
    doc.text(`Completed By: ${header.filledBy}`, 10, y); y += 6;
    doc.text(`Date: ${TODAY}`, 10, y); y += 6;
    doc.text("Final Confirmation: YES", 10, y); y += 10;

    doc.setFont("helvetica","bold");
    doc.text("Checklist Summary", 10, y); y += 7;

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);

    answers.forEach(a => {
      const line = `${a.number}. ${a.question} ‚Äî ${a.answer}`;
      const lines = doc.splitTextToSize(line, 190);
      if(y > 275){ doc.addPage(); y = 14; }
      doc.text(lines, 10, y);
      y += (lines.length * 5) + 1;
    });

    if(y > 250){ doc.addPage(); y = 14; }
    y += 6;
    doc.setFont("helvetica","bold");
    doc.text("Sign-off", 10, y); y += 8;
    doc.setFont("helvetica","normal");
    doc.text("Bench staff signature: ________________________________", 10, y); y += 10;
    doc.text("Supervisor / checked by: _____________________________", 10, y); y += 10;

    const fileName =
      `${DONE_EMOJI}_` +
      safeName(header.jobNumber) + "_" +
      safeName(header.room) + "_" +
      safeName(header.filledBy) + "_CABINETRY_COMPLETED.pdf";

    doc.save(fileName);
  }

  window.saveJSON = saveJSON;
  window.loadJSON = loadJSON;
  window.exportCompletionPDF = exportCompletionPDF;

  renderQuestions();

  // Default final to NO to prevent ‚Äúblank final‚Äù confusion (and it's safer).
  finalNoInput.checked = true;

  evaluateCompletionState();
</script>
</body>
</html>
